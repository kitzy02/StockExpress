<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Invest - Stock Express</title>
  <link rel="icon" href="/favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Poppins', sans-serif; }
    .logo-icon { animation: pulse 2s infinite; }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    .section-card {
      background: linear-gradient(145deg, rgba(248,243,217,0.95), rgba(235,229,194,0.9));
      border: 1px solid rgba(185,178,138,0.3);
      backdrop-filter: blur(10px);
      border-radius: 1.5rem;
      padding: 2rem;
      box-shadow: 0 10px 25px rgba(80, 75, 56, 0.1);
      transition: transform 0.3s ease;
    }
    .section-card:hover { transform: translateY(-5px); }
    .btn-dashboard {
      background: #504B38;
      color: #F8F3D9;
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 20px rgba(80, 75, 56, 0.2);
    }
    .btn-dashboard:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 25px rgba(80, 75, 56, 0.3);
    }
    .btn-dashboard::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    .btn-dashboard:hover::before { left: 100%; }
    .navbar-blur {
      backdrop-filter: blur(20px);
      background: rgba(185, 178, 138, 0.95);
    }
      .stock-table-container {
        background: linear-gradient(145deg, rgba(248, 243, 217, 0.95), rgba(235, 229, 194, 0.9));
        border: 1px solid rgba(185, 178, 138, 0.3);
        backdrop-filter: blur(12px);
        border-radius: 1.5rem;
        overflow: hidden;
        box-shadow: 0 12px 35px rgba(80, 75, 56, 0.15);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }
      .stock-table-container:hover {
        transform: translateY(-4px);
        box-shadow: 0 18px 45px rgba(80, 75, 56, 0.2);
      }
      
      .stock-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background: transparent;
        font-family: 'Segoe UI', 'Roboto', sans-serif;
      }
      
      .stock-table thead {
        background: linear-gradient(135deg, #504B38, #3D3829);
        color: #F8F3D9;
        position: relative;
      }
      .stock-table thead::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, transparent, rgba(185, 178, 138, 0.5), transparent);
      }
      
      .stock-table th {
        padding: 1.25rem 1.5rem;
        font-size: 0.9rem;
        font-weight: 700;
        letter-spacing: 0.5px;
        text-align: left;
        text-transform: uppercase;
      }
      
      .stock-table tbody tr {
        background: rgba(248, 243, 217, 0.35);
        border-bottom: 1px solid rgba(185, 178, 138, 0.2);
        transition: all 0.3s ease;
      }
      .stock-table tbody tr:hover {
        background: rgba(235, 229, 194, 0.65);
        transform: translateX(8px);
        box-shadow: inset 4px 0 0 #B9B28A;
      }
      
      .stock-table td {
        padding: 1.25rem 1.5rem;
        color: #504B38;
        font-weight: 500;
        font-size: 0.95rem;
        vertical-align: middle;
      }
      
      /* Optional extras for crisp visual finish */
      .stock-table tbody tr:last-child {
        border-bottom: none;
      }
      .stock-table td:first-child,
      .stock-table th:first-child {
        border-top-left-radius: 0.75rem;
      }
      .stock-table td:last-child,
      .stock-table th:last-child {
        border-top-right-radius: 0.75rem;
      }
      
    .buy-btn {
      background: linear-gradient(135deg, #3f5c3b, #2f4c2c); /* Earthy green gradient */
      color: #F8F3D9; /* Light beige from your theme */
      padding: 0.5rem 1rem;
      border-radius: 0.75rem;
      font-weight: 600;
      font-size: 0.875rem;
      margin-right: 0.5rem;
      box-shadow: 0 4px 12px rgba(63, 92, 59, 0.3); /* Subtle green shadow */
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .buy-btn:hover {
      transform: translateY(-2px);
      background: linear-gradient(135deg, #4c6b45, #3a5b38); /* Slightly brighter on hover */
    }
    
    .toast {
      background: linear-gradient(135deg, #e7eddc, #cddbc1); /* Soft moss green */
      color: #333024; /* Earthy dark brown for legibility */
      border-radius: 0.75rem;
      padding: 1rem 1.25rem;
      box-shadow: 0 10px 25px rgba(48, 65, 40, 0.2); /* Gentle greenish shadow */
      font-weight: 500;
      max-width: 320px;
    }
    
    
  </style>
</head>

<body class="bg-[#F8F3D9] text-[#504B38] min-h-screen flex flex-col">

  <!-- Navbar -->
  <nav class="navbar-blur py-4 px-6 shadow-lg sticky top-0 z-50">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center space-x-3">
        <svg class="w-8 h-8 logo-icon" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect width="40" height="40" rx="8" fill="#504B38"/>
          <path d="M12 24L16 20L20 22L28 14" stroke="#F8F3D9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="28" cy="14" r="2" fill="#B9B28A"/>
        </svg>
        <h1 class="text-2xl font-bold text-[#504B38]">Stock Express</h1>
      </div>
      <ul class="flex gap-8 font-semibold text-[#504B38]">
        <li><a href="stocks.html" class="hover:text-[#333024] transition-colors duration-300 relative group">Stocks</a></li>
        <li><a href="watchlist.html"class="hover:text-[#333024] transition-colors duration-300 relative group">Watchlist</a></li>
        <li><a href="holdings.html" class="hover:text-[#333024] transition-colors duration-300 relative group">Holdings</a></li>
        <li><a href="chat.html" class="hover:text-[#333024] transition-colors duration-300 relative group">Finn</a></li>
        <li><a href="login.html" class="bg-[#504B38] text-[#F8F3D9] px-4 py-2 rounded-lg hover:bg-[#333024] transition-colors duration-300">Log Out</a></li>
     
      </ul>
    </div>
  </nav>

  <!-- Header -->
  <main class="flex-1 px-6 py-6">
    <div class="text-center mb-8">
        
        <div class="flex justify-center items-center mb-8">
            <h1 class="text-4xl font-bold text-[#333024] flex items-center gap-3">
              <svg class="w-10 h-10 logo-icon" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect width="40" height="40" rx="8" fill="#504B38"/>
                <path d="M12 24L16 20L20 22L28 14" stroke="#F8F3D9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="28" cy="14" r="2" fill="#B9B28A"/>
              </svg>
              Stocks Dashboard
            </h1>
          </div>
          
      <p id="lastUpdated" class="text-sm text-[#5e5a48] font-medium">Loading stock data...</p>
    </div>

    <!-- Table -->
    <div class="stock-table-container">
      <table class="stock-table">
        <thead>
          <tr>
            <th>Company</th>
            <th>Price</th>
            <th>52W High</th>
            <th>52W Low</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="stockTableBody"></tbody>
      </table>
    </div>
  </main>

  <!-- Buy Modal -->
  <!-- Buy Modal -->
<div class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm hidden items-center justify-center z-50" id="buyModal">
    <div class="modal-container p-6 w-full max-w-md bg-[#F8F3D9] border border-[#B9B28A] rounded-2xl shadow-xl">
      <h3 id="modalCompany" class="text-2xl font-semibold text-[#333024] mb-3">Company Name</h3>
      <p class="text-[#5e5a48] font-medium mb-4">Price: ₹<span id="modalPrice" class="font-semibold text-[#504B38]">0</span></p>
      
      <input
        id="quantity"
        type="number"
        min="1"
        placeholder="Enter quantity"
        class="w-full modal-input border-2 border-[#B9B28A] rounded-lg px-4 py-2 text-[#504B38] font-medium focus:outline-none focus:ring-2 focus:ring-[#B9B28A] mb-5"
      />
  
      <div class="flex justify-end gap-4">
        <button onclick="closeModal()" class="modal-btn-cancel bg-[#e7e2c3] hover:bg-[#d9d3a7] text-[#504B38] px-4 py-2 rounded-lg font-semibold transition">Cancel</button>
        <button onclick="buyStock()" class="modal-btn-buy bg-[#504B38] hover:bg-[#3d3829] text-[#F8F3D9] px-5 py-2 rounded-lg font-semibold transition shadow-md">Buy</button>
      </div>
    </div>
  </div>
  

  <!-- Toasts -->
  <div id="buyToast" class="fixed bottom-6 right-6 toast px-4 py-2 hidden">Purchase confirmed</div>
  <div id="watchlistToast" class="fixed bottom-20 right-6 toast px-4 py-2 hidden">Added to Watchlist</div>

  <!-- Footer -->
  <footer class="bg-[#504B38] text-[#F8F3D9] py-6 px-6">
    <div class="max-w-6xl mx-auto flex justify-between items-center text-sm">
      <span>© 2025 Stock Express</span>
      <span>Auto-refresh every 10 seconds</span>
    </div>
  </footer>

  <!-- JS -->
  <script>
    const USER_ID = 1;
    let currentStock = null;

    async function fetchStocks() {
      try {
        const res = await fetch('http://localhost:5000/stocks');
        const stocks = await res.json();
        const tbody = document.getElementById('stockTableBody');
        tbody.innerHTML = '';

        stocks.forEach(stock => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${stock.company_name}</td>
            <td>₹${stock.price}</td>
            <td>₹${stock.week_52_high}</td>
            <td>₹${stock.week_52_low}</td>
            <td>
              <button class="buy-btn" onclick='openBuyModal(${JSON.stringify(stock)})'>Buy</button>
             <button class="buy-btn" onclick='addToWatchlist(${stock.sl_no}, "${stock.company_name}")'>Watchlist</button>

            </td>
          `;
          tbody.appendChild(row);
        });

        document.getElementById('lastUpdated').innerText = `Last updated: ${new Date().toLocaleTimeString()}`;
      } catch (err) {
        document.getElementById('lastUpdated').innerText = 'Failed to load data.';
        console.error('Error:', err);
      }
    }

    async function addToWatchlist(stockId, companyName) {
        try {
          const res = await fetch('http://localhost:5000/watchlist/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ stock_id: stockId })
          });
      
          if (!res.ok) throw new Error('Failed to add to watchlist');
      
          const toast = document.getElementById('watchlistToast');
          toast.innerText = `✔ Added ${companyName} to Watchlist`;
          toast.classList.remove('hidden');
          setTimeout(() => toast.classList.add('hidden'), 4000);
        } catch (err) {
          alert('❌ Could not add to Watchlist');
          console.error(err);
        }
      }
      
    function openBuyModal(stock) {
      currentStock = stock;
      document.getElementById('modalCompany').innerText = stock.company_name;
      document.getElementById('modalPrice').innerText = stock.price;
      document.getElementById('quantity').value = '';
      document.getElementById('buyModal').classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('buyModal').classList.add('hidden');
    }

    async function buyStock() {
      const qty = parseInt(document.getElementById('quantity').value);
      if (!qty || qty <= 0) {
        alert('Enter a valid quantity');
        return;
      }

      const totalAmount = qty * currentStock.price;

      try {
        await fetch('http://localhost:5000/holdings/buy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            company_name: currentStock.company_name,
            quantity: qty
          })
        });

        await fetch('http://localhost:5000/transactions/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            company_name: currentStock.company_name,
            transaction_type: 'buy',
            quantity: qty
          })
        });

        await fetch(`http://localhost:5000/users/${USER_ID}/`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount: totalAmount, type: 'buy' })
        });

        closeModal();
        const toast = document.getElementById('buyToast');
        toast.innerText = `✔ Bought ${qty} shares of ${currentStock.company_name}`;
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 4000);
      } catch (error) {
        alert('❌ Failed to complete transaction');
        console.error(error);
      }
    }

    fetchStocks();
    setInterval(fetchStocks, 60000); 
  </script>
</body>
</html>
